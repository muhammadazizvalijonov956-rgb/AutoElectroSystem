<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>

<style>
body{
    margin:0;
    background:#070147;
    font-family:"Segoe UI",sans-serif;
    color:white;
}

header{
    padding:20px 40px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#0b0549;
    border-bottom:2px solid #00ffff;
}

header h2{
    margin:0;
    color:#00ffff;
}

header button{
    padding:8px 18px;
    border:none;
    border-radius:20px;
    font-weight:700;
    cursor:pointer;
    background:#ff5555;
    color:white;
}

.container{
    max-width:1200px;
    margin:40px auto;
    padding:0 20px;
}

table{
    width:100%;
    border-collapse:collapse;
    background:rgba(255,255,255,0.06);
    border-radius:14px;
    overflow:hidden;
}

thead{
    background:#0b0549;
}

th,td{
    padding:14px;
    text-align:left;
    font-size:14px;
}

th{
    color:#00ffff;
    font-weight:700;
}

tr:nth-child(even){
    background:rgba(255,255,255,0.03);
}

tr:hover{
    background:rgba(0,255,255,0.1);
}

.empty{
    text-align:center;
    margin-top:40px;
    color:#aaa;
}
.stats-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap:20px;
    margin-bottom:30px;
    margin-top: 30px;
}

.stat-card{
    background:rgba(255,255,255,0.06);
    border-radius:14px;
    padding:20px;
    text-align:center;
    box-shadow:0 0 25px rgba(0,255,255,0.15);
}

.stat-number{
    font-size:32px;
    font-weight:800;
    color:#00ffff;
}

.stat-label{
    margin-top:6px;
    font-size:14px;
    color:#ccc;
}

</style>
</head>

<body>

<header>
    <h2>ðŸ“Š Test Natijalari</h2>
    <button onclick="logout()">Chiqish</button>
</header>
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number" id="totalSub">0</div>
        <div class="stat-label">Topshiruvlar</div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="avgScore">0%</div>
        <div class="stat-label">Oâ€˜rtacha natija</div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="passCount">0</div>
        <div class="stat-label">Oâ€˜tganlar</div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="failCount">0</div>
        <div class="stat-label">Yiqilganlar</div>
    </div>

    <div class="stat-card">
        <div class="stat-number" id="passRate">0%</div>
        <div class="stat-label">Oâ€˜tish foizi</div>
    </div>
</div>

<div style="margin-bottom:20px; display:flex; gap:12px; align-items:center;">
    <label style="font-weight:600;">Test:</label>
    <select id="testFilter" onchange="loadResults()" style="padding:8px 12px; border-radius:8px;">
        <option value="all">Barchasi</option>
        <option value="akkumulyator_1">Akkumulyator</option>
        <option value="generator_1">Generator</option>
        <option value="yoritish_1">Yoritish</option>
    </select>

    <button onclick="exportCSV()" style="margin-left:auto; padding:8px 16px; border-radius:20px; font-weight:700; cursor:pointer;">
        â¬‡ Export CSV
    </button>
</div>


<div class="container">
    <table>
        <thead>
            <tr>
                <th>Ism</th>
                <th>Familiya</th>
                <th>Email</th>
                <th>Test</th>
                <th>Ball</th>
                <th>Vaqt</th>
            </tr>
        </thead>
        <tbody id="results"></tbody>
    </table>

    <div id="empty" class="empty" style="display:none">
        Hozircha natijalar yoâ€˜q
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCDbOvEFvs1eOiYFrO7r2DGFmcQzSQG4i4",
  authDomain: "avtomobillarelektrtizimlari.firebaseapp.com",
  projectId: "avtomobillarelektrtizimlari",
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

auth.onAuthStateChanged(user=>{
    if(!user) location.replace("admin-login.html");
    else loadResults();
});

function loadResults(){
    const filter = document.getElementById("testFilter").value;

    let query = db.collection("results").orderBy("createdAt","desc");

    if(filter !== "all"){
        query = query.where("testId","==",filter);
    }

    query.onSnapshot(snap => {

        const tbody = document.getElementById("results");
        tbody.innerHTML = "";

        let totalSub = snap.size;
        let totalScore = 0;
        let totalPossible = 0;
        let pass = 0;
        let fail = 0;

        if(snap.empty){
            document.getElementById("empty").style.display="block";
            return;
        }
        document.getElementById("empty").style.display="none";

        snap.forEach(doc=>{
            const d = doc.data();
            const score = Number(d.score);
            const total = Number(d.total);
            const percent = (score / total) * 100;

            totalScore += score;
            totalPossible += total;

            percent >= 60 ? pass++ : fail++;

            tbody.innerHTML += `
              <tr>
                <td>${d.name}</td>
                <td>${d.surname}</td>
                <td>${d.email}</td>
                <td>${d.testId}</td>
                <td>${score}/${total}</td>
                <td>${d.createdAt?.toDate().toLocaleString() || ""}</td>
              </tr>`;
        });

        const avg = totalPossible ? Math.round((totalScore/totalPossible)*100) : 0;
        const passRate = totalSub ? Math.round((pass/totalSub)*100) : 0;

        document.getElementById("totalSub").textContent = totalSub;
        document.getElementById("avgScore").textContent = avg + "%";
        document.getElementById("passCount").textContent = pass;
        document.getElementById("failCount").textContent = fail;
        document.getElementById("passRate").textContent = passRate + "%";
    });
}


function logout(){
    auth.signOut().then(()=> location.replace("admin-login.html"));
}
function exportCSV(){
    const rows = [];
    rows.push(["Ism","Familiya","Email","Test","Ball","Vaqt"]);

    document.querySelectorAll("#results tr").forEach(tr=>{
        const cols = Array.from(tr.children).map(td => `"${td.innerText}"`);
        rows.push(cols.join(","));
    });

    const csv = rows.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "test_results.csv";
    a.click();

    URL.revokeObjectURL(url);
}

</script>

</body>
</html>
